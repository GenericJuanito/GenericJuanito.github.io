<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mount 2000 Assignment Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.4;
            position: relative;
        }

        /* Watermark Background */
        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-image: url('');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.03;
            z-index: -1;
            pointer-events: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #061d28, #0a2635);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 8px;
            font-size: 2.2em;
        }

        .header h2 {
            margin-bottom: 0;
            font-size: 1.2em;
            font-weight: 400;
            opacity: 0.9;
        }

        /* Tab System */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .tab-button.active {
            background: #061d28;
            color: white;
        }

        .tab-button:hover {
            background: #061d28;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Statistics */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #c9a96e, #a68b5b);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 1.6em;
            margin-bottom: 8px;
        }

        /* Search */
        .search-bar {
            width: 100%;
            padding: 15px;
            border: 3px solid #061d28;
            border-radius: 8px;
            font-size: 18px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(6, 29, 40, 0.2);
        }

        .search-bar:focus {
            outline: none;
            border-color: #0a2635;
            box-shadow: 0 4px 15px rgba(6, 29, 40, 0.3);
        }

        /* Room Cards */
        .room-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #061d28;
            transition: all 0.3s ease;
            position: relative;
        }

        .room-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Status Indicators */
        .section-id {
            background: #061d28;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .assignment-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-assigned { background: #27ae60; color: white; }
        .status-unassigned { background: #e74c3c; color: white; }

        /* Gender Color Coding */
        .male-section {
            background: #e8f0f2;
            border-left: 4px solid #061d28;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }

        .female-section {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
            padding: 10px;
            border-radius: 6px;
            margin: 5px 0;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
        }

        .btn-primary { background: #061d28; color: white; }
        .btn-primary:hover { background: #0a2635; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }

        .table th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #061d28;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        /* Capacity Displays */
        .capacity-display {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .capacity-positive { background: #d4edda; color: #155724; }
        .capacity-negative { background: #f8d7da; color: #721c24; }
        .capacity-zero { background: #fff3cd; color: #856404; }

        /* Table Containers */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 10px;
        }

        /* Management Sections */
        .management-section {
            margin-top: 30px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 10px;
        }

        /* Notifications */
        .notification {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 600;
        }

        .notification.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .header {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .header h1 {
                font-size: 1.1em;
                margin-bottom: 4px;
            }
            
            .header h2 {
                font-size: 0.75em;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .stat-card h3 {
                font-size: 1.2em;
                margin-bottom: 5px;
            }
            
            .stat-card p {
                font-size: 0.8em;
            }
            
            .tabs {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 4px;
            }
            
            .tab-button {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .search-bar {
                padding: 12px;
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            .room-card {
                padding: 12px;
                margin: 8px 0;
            }
            
            .table {
                font-size: 11px;
            }
            
            .table th, .table td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mount 2000 Assignment Dashboard</h1>
            <h2>Housing and Small Group Room Assignments - 2025</h2>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">Assignment Dashboard</button>
            <button class="tab-button" onclick="switchTab('management')">Management Interface</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Assignment Dashboard</h2>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="total-groups">0</h3>
                    <p>Total Youth Groups</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-participants">0</h3>
                    <p>Total Participants</p>
                </div>
            </div>

            <h3 style="margin-bottom: 10px; color: #061d28;">🔍 Quick Parish Assignment Search</h3>
            <input type="text" class="search-bar" id="parish-search" placeholder="🔍 Search by Parish name, Group ID, or Leader name..." oninput="performSearch()" autocomplete="off">
            
            <div id="search-results"></div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                <h3>Complete Assignment Overview</h3>
                <div id="assignment-overview"></div>
            </div>

            <div style="text-align: center; margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef;">
                <button class="btn btn-primary" onclick="exportCompleteHTML()" style="padding: 8px 16px; font-size: 13px;">🌐</button>
                <p style="font-size: 11px; color: #6c757d; margin-top: 8px;">
                    Create portable file for web hosting
                </p>
            </div>
        </div>

        <!-- Management Interface Tab -->
        <div id="management" class="tab-content">
            <h2>System Management</h2>
            
            <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: #e8f0f2; border-radius: 8px;">
                <h3 style="color: #061d28; margin-bottom: 15px;">📂 Data Management</h3>
                <button class="btn btn-primary" onclick="loadData()">📂 Import Data</button>
                <button class="btn btn-success" onclick="saveData()">💾 Save Data</button>
                <button class="btn btn-warning" onclick="exportToCSV()">📥 Export CSV</button>
                <p style="font-size: 12px; color: #061d28; margin-top: 10px;">
                    💡 Use Import Data to load previously saved housing assignments
                </p>
            </div>
            
            <input type="file" id="load-file" accept=".json" style="display: none;" onchange="handleLoadFile(event)">

            <div class="management-section">
                <h3>All Youth Groups</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Group ID</th>
                                <th>Parish</th>
                                <th>Leader</th>
                                <th>Phone</th>
                                <th>Total</th>
                                <th>SGL</th>
                                <th>Meal Color</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="youth-groups-table"></tbody>
                    </table>
                </div>
            </div>

            <div class="management-section">
                <h3>Meal Color Assignment Dashboard</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Group ID</th>
                                <th>Parish</th>
                                <th>Leader</th>
                                <th>Total People</th>
                                <th>Meal Color</th>
                                <th>Small Group Leader</th>
                            </tr>
                        </thead>
                        <tbody id="meal-color-table"></tbody>
                    </table>
                </div>
            </div>

            <div class="management-section">
                <h3>All Housing Rooms</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Building</th>
                                <th>Room/Section</th>
                                <th>Gender</th>
                                <th>Capacity</th>
                                <th>Available</th>
                                <th>Assigned Groups</th>
                            </tr>
                        </thead>
                        <tbody id="housing-rooms-table"></tbody>
                    </table>
                </div>
            </div>

            <div class="management-section">
                <h3>All Small Group Rooms</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Building</th>
                                <th>Room/Location</th>
                                <th>Gender</th>
                                <th>Capacity</th>
                                <th>Available</th>
                                <th>Assigned Groups</th>
                            </tr>
                        </thead>
                        <tbody id="small-group-rooms-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let appData = {
            youthGroups: [],
            housingRooms: [],
            smallGroupRooms: [],
            housingAssignments: {
                male: {},
                female: {}
            },
            smallGroupAssignments: {},
            mealColorAssignments: {}
        };

        // ===== SYSTEM INITIALIZATION =====
        function initializeSystem() {
            loadSampleData();
            updateAllDisplays();
            setupKeyboardShortcuts();
            setupWatermarkLogo();
            
            // Ensure search works immediately
            setTimeout(() => {
                const searchInput = document.getElementById('parish-search');
                if (searchInput) {
                    searchInput.addEventListener('input', performSearch);
                    searchInput.addEventListener('keyup', performSearch);
                }
            }, 100);
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                if ((event.metaKey || event.ctrlKey) && event.key === 's') {
                    event.preventDefault();
                    exportCompleteHTML();
                }
            });
        }

        function setupWatermarkLogo() {
            if (window.fs && window.fs.readFile) {
                window.fs.readFile('image-1.png')
                    .then(data => {
                        const blob = new Blob([data], { type: 'image/png' });
                        const imageUrl = URL.createObjectURL(blob);
                        
                        const style = document.createElement('style');
                        style.textContent = `
                            body::before {
                                background-image: url('${imageUrl}') !important;
                            }
                        `;
                        document.head.appendChild(style);
                    })
                    .catch(error => {
                        console.log('Logo not available:', error);
                    });
            }
        }

        function loadSampleData() {
            appData.youthGroups = [
                {
                    id: 'STM001',
                    parish: 'St. Mary Parish',
                    leader: 'John Smith',
                    phone: '(301) 555-0123',
                    maleTeens: 8,
                    femaleTeens: 12,
                    maleChaperones: 2,
                    femaleChaperones: 3,
                    specialAccommodations: '',
                    seminarianSgl: 'Fr. Matthew Jones'
                },
                {
                    id: 'HFA002',
                    parish: 'Holy Family Parish',
                    leader: 'Sarah Johnson',
                    phone: '(301) 555-0456',
                    maleTeens: 6,
                    femaleTeens: 8,
                    maleChaperones: 1,
                    femaleChaperones: 2,
                    specialAccommodations: 'CPAP machine needed',
                    seminarianSgl: 'Zack Billings'
                },
                {
                    id: 'SPA003',
                    parish: 'St. Patrick Parish',
                    leader: 'Michael Davis',
                    phone: '(301) 555-0789',
                    maleTeens: 10,
                    femaleTeens: 6,
                    maleChaperones: 3,
                    femaleChaperones: 2,
                    specialAccommodations: 'Wheelchair access needed',
                    seminarianSgl: 'John Mark'
                }
            ];

            appData.housingRooms = [
                {
                    building: 'Gymnasium',
                    roomId: 'East Section',
                    gender: 'male',
                    capacity: 25,
                    accessibility: ''
                },
                {
                    building: 'Gymnasium',
                    roomId: 'West Section',
                    gender: 'female',
                    capacity: 30,
                    accessibility: ''
                }
            ];

            appData.smallGroupRooms = [
                {
                    building: 'Student Center',
                    roomId: 'Conference Room A',
                    gender: 'male',
                    capacity: 15,
                    features: 'Projector, whiteboard, round tables'
                },
                {
                    building: 'Student Center',
                    roomId: 'Conference Room B',
                    gender: 'female',
                    capacity: 15,
                    features: 'Projector, whiteboard, round tables'
                }
            ];

            appData.housingAssignments = {
                male: {
                    'STM001': ['Gymnasium-East Section']
                },
                female: {
                    'STM001': ['Gymnasium-West Section'],
                    'HFA002': ['Gymnasium-West Section']
                }
            };
            
            appData.smallGroupAssignments = {
                'STM001': ['Student Center-Conference Room A'],
                'HFA002': ['Student Center-Conference Room B']
            };
            
            appData.mealColorAssignments = {
                'STM001': 'Yellow',
                'HFA002': 'Orange',
                'SPA003': 'Blue'
            };
        }

        // ===== TAB MANAGEMENT =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ===== UTILITY FUNCTIONS =====
        function getMealColorStyle(color) {
            if (!color) return { background: '#f8f9fa', color: '#6c757d', text: 'No Color' };
            
            const colorMap = {
                'Red': { background: '#dc3545', color: 'white', text: 'Red' },
                'Blue': { background: '#007bff', color: 'white', text: 'Blue' },
                'Green': { background: '#28a745', color: 'white', text: 'Green' },
                'Yellow': { background: '#ffc107', color: '#212529', text: 'Yellow' },
                'Orange': { background: '#fd7e14', color: 'white', text: 'Orange' },
                'Purple': { background: '#6f42c1', color: 'white', text: 'Purple' },
                'Pink': { background: '#e83e8c', color: 'white', text: 'Pink' },
                'Grey': { background: '#6c757d', color: 'white', text: 'Grey' },
                'Black': { background: '#343a40', color: 'white', text: 'Black' },
                'White': { background: '#f8f9fa', color: '#212529', text: 'White' }
            };
            
            return colorMap[color] || { background: '#f8f9fa', color: '#6c757d', text: color };
        }

        function isGroupHousingAssigned(groupId) {
            const maleAssignments = appData.housingAssignments.male[groupId];
            const femaleAssignments = appData.housingAssignments.female[groupId];
            return (Array.isArray(maleAssignments) && maleAssignments.length > 0) ||
                   (Array.isArray(femaleAssignments) && femaleAssignments.length > 0);
        }

        function isGroupSmallGroupAssigned(groupId) {
            const assignments = appData.smallGroupAssignments[groupId];
            return Array.isArray(assignments) && assignments.length > 0;
        }

        function getHousingRoomOccupancy(roomKey) {
            let total = 0;
            
            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const assignments = appData.housingAssignments.male[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.maleTeens + group.maleChaperones;
                    }
                }
            });
            
            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const assignments = appData.housingAssignments.female[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.femaleTeens + group.femaleChaperones;
                    }
                }
            });
            
            return total;
        }

        function getSmallGroupRoomOccupancy(roomKey) {
            let total = 0;
            
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const assignments = appData.smallGroupAssignments[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    const group = appData.youthGroups.find(g => g.id === groupId);
                    if (group) {
                        total += group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                    }
                }
            });
            
            return total;
        }

        function getHousingRoomAssignedGroupsDisplay(roomKey) {
            const assignedGroups = [];
            
            Object.keys(appData.housingAssignments.male).forEach(groupId => {
                const assignments = appData.housingAssignments.male[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(`${groupId}(M)`);
                }
            });
            
            Object.keys(appData.housingAssignments.female).forEach(groupId => {
                const assignments = appData.housingAssignments.female[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(`${groupId}(F)`);
                }
            });
            
            return assignedGroups.join(', ') || 'None';
        }

        function getSmallGroupRoomAssignedGroupsDisplay(roomKey) {
            const assignedGroups = [];
            
            Object.keys(appData.smallGroupAssignments).forEach(groupId => {
                const assignments = appData.smallGroupAssignments[groupId];
                if (Array.isArray(assignments) && assignments.includes(roomKey)) {
                    assignedGroups.push(groupId);
                }
            });
            
            return assignedGroups.join(', ') || 'None';
        }

        // ===== CREATE GROUP CARD FUNCTION =====
        function createGroupCard(group, isSearch = false) {
            const isHousingAssigned = isGroupHousingAssigned(group.id);
            const isSmallGroupAssigned = isGroupSmallGroupAssigned(group.id);
            const maleTotal = group.maleTeens + group.maleChaperones;
            const femaleTotal = group.femaleTeens + group.femaleChaperones;
            const totalGroup = maleTotal + femaleTotal;
            
            // Get housing assignments
            const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
            const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
            
            const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building}-${room.roomId}` : roomKey;
            });
            
            const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building}-${room.roomId}` : roomKey;
            });
            
            // Get small group assignments
            const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
            
            const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                return room ? `${room.building}-${room.roomId}` : roomKey;
            });
            
            const overallAssigned = isHousingAssigned || isSmallGroupAssigned;
            
            // Get meal color and seminarian info
            const mealColor = appData.mealColorAssignments[group.id];
            const mealColorStyle = getMealColorStyle(mealColor);
            const seminarian = group.seminarianSgl || '';
            
            const backgroundStyle = isSearch ? (overallAssigned ? '#f0fff4' : '#fff5f5') : '';
            
            return `
                <div class="room-card" style="border-left-color: ${overallAssigned ? '#27ae60' : '#e74c3c'}; background: ${backgroundStyle}; position: relative;">
                    <!-- Meal Color Tab -->
                    ${mealColor ? `<div style="position: absolute; top: 8px; right: 8px; background: ${mealColorStyle.background}; color: ${mealColorStyle.color}; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; z-index: 2;">${mealColorStyle.text}</div>` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-right: ${mealColor ? '60px' : '0'};">
                        <strong style="font-size: 16px;">${group.parish}</strong>
                        <div style="display: flex; gap: 5px;">
                            <span class="assignment-status ${isHousingAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                🏠 ${isHousingAssigned ? '✅' : '❌'}
                            </span>
                            <span class="assignment-status ${isSmallGroupAssigned ? 'status-assigned' : 'status-unassigned'}" style="font-size: 10px;">
                                👥 ${isSmallGroupAssigned ? '✅' : '❌'}
                            </span>
                        </div>
                    </div>
                    <p><span class="section-id">${group.id}</span> | <strong>Leader:</strong> ${group.leader} | <strong>Phone:</strong> ${group.phone}</p>
                    <p><strong>Total People:</strong> ${totalGroup} (${maleTotal} males, ${femaleTotal} females)</p>
                    ${group.specialAccommodations ? `<p style="margin-top: 8px; font-size: 12px; background: #fff3cd; padding: 4px; border-radius: 4px;"><strong>⚠️ Special Accommodations:</strong> ${group.specialAccommodations}</p>` : ''}
                    
                    <!-- Small Group Leader -->
                    ${seminarian ? `<p style="font-size: 11px; color: #6c757d; margin-top: 8px; font-style: italic;">👨‍🏫 <strong>Small Group Leader:</strong> ${seminarian}</p>` : ''}
                    
                    <!-- Housing Assignments -->
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin: 8px 0;">
                        <strong style="font-size: 14px;">🏠 Housing Assignments</strong>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px;">
                            ${maleTotal > 0 ? `
                                <div class="male-section" style="padding: 6px;">
                                    <strong style="font-size: 12px;">🔵 Males: ${maleTotal}</strong>
                                    ${maleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0; font-weight: bold; color: #27ae60;">${maleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0; font-weight: bold;">❌ Not assigned</p>'}
                                </div>
                            ` : '<div></div>'}
                            
                            ${femaleTotal > 0 ? `
                                <div class="female-section" style="padding: 6px;">
                                    <strong style="font-size: 12px;">🟣 Females: ${femaleTotal}</strong>
                                    ${femaleHousingRoomNames.length > 0 ? `<p style="font-size: 10px; margin: 2px 0 0 0; font-weight: bold; color: #27ae60;">${femaleHousingRoomNames.join(', ')}</p>` : '<p style="font-size: 10px; color: #e67e22; margin: 2px 0 0 0; font-weight: bold;">❌ Not assigned</p>'}
                                </div>
                            ` : '<div></div>'}
                        </div>
                    </div>
                    
                    <!-- Small Group Assignments -->
                    <div style="background: #f0f8ff; padding: 8px; border-radius: 6px; margin: 8px 0;">
                        <strong style="font-size: 14px;">👥 Small Group Location</strong>
                        ${groupSmallGroupRoomNames.length > 0 ? `
                            <div style="background: linear-gradient(45deg, #e8f4f8, #fdf2f2); padding: 6px; border-radius: 4px; margin-top: 5px;">
                                <strong style="font-size: 12px;">🟡 Group Location:</strong>
                                <p style="font-size: 10px; margin: 2px 0 0 0; font-weight: bold; color: #27ae60;">${groupSmallGroupRoomNames.join(', ')}</p>
                            </div>
                        ` : `<div style="background: #fff3cd; padding: 4px; border-radius: 4px; margin-top: 5px; text-align: center;">
                            <p style="font-size: 10px; color: #856404; margin: 0; font-weight: bold;">❌ No small group location assigned</p>
                        </div>`}
                    </div>
                </div>
            `;
        }

        // ===== DISPLAY UPDATE FUNCTIONS =====
        function updateAllDisplays() {
            updateYouthGroupsTable();
            updateMealColorTable();
            updateHousingRoomsTable();
            updateSmallGroupRoomsTable();
            updateDashboard();
            updateAssignmentOverview();
        }

        function updateDashboard() {
            const totalGroupsElement = document.getElementById('total-groups');
            const totalParticipantsElement = document.getElementById('total-participants');
            
            if (totalGroupsElement) totalGroupsElement.textContent = appData.youthGroups.length;
            if (totalParticipantsElement) totalParticipantsElement.textContent = appData.youthGroups.reduce((total, group) => 
                total + group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones, 0);
        }

        function updateAssignmentOverview() {
            const overviewDiv = document.getElementById('assignment-overview');
            if (!overviewDiv) return;
            
            if (appData.youthGroups.length === 0) {
                overviewDiv.innerHTML = '<p>No youth groups added yet.</p>';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px;">';
            
            appData.youthGroups.forEach(group => {
                html += createGroupCard(group, false);
            });
            
            html += '</div>';
            overviewDiv.innerHTML = html;
        }

        function updateYouthGroupsTable() {
            const tbody = document.getElementById('youth-groups-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            appData.youthGroups.forEach((group, index) => {
                const total = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                const isAssigned = isGroupHousingAssigned(group.id);
                const mealColor = appData.mealColorAssignments[group.id];
                const mealColorStyle = getMealColorStyle(mealColor);
                const seminarian = group.seminarianSgl || '';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="section-id">${group.id}</span></td>
                    <td>${group.parish}</td>
                    <td>${group.leader}</td>
                    <td>${group.phone}</td>
                    <td><strong>${total}</strong></td>
                    <td style="font-size: 11px; font-style: italic;">${seminarian || 'Not assigned'}</td>
                    <td>${mealColor ? `<span style="background: ${mealColorStyle.background}; color: ${mealColorStyle.color}; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">${mealColorStyle.text}</span>` : '<span style="color: #6c757d;">No Color</span>'}</td>
                    <td><span class="assignment-status ${isAssigned ? 'status-assigned' : 'status-unassigned'}">${isAssigned ? '✅ Assigned' : '❌ Unassigned'}</span></td>
                `;
            });
        }

        function updateMealColorTable() {
            const tbody = document.getElementById('meal-color-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            appData.youthGroups.forEach(group => {
                const totalPeople = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                const mealColor = appData.mealColorAssignments[group.id];
                const mealColorStyle = getMealColorStyle(mealColor);
                const seminarian = group.seminarianSgl || '';
                
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td><span class="section-id">${group.id}</span></td>
                    <td>${group.parish}</td>
                    <td>${group.leader}</td>
                    <td><strong>${totalPeople}</strong></td>
                    <td>${mealColor ? `<span style="background: ${mealColorStyle.background}; color: ${mealColorStyle.color}; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">${mealColorStyle.text}</span>` : '<span style="color: #6c757d;">No Color</span>'}</td>
                    <td style="font-size: 11px; font-style: italic;">${seminarian || 'Not assigned'}</td>
                `;
            });
        }

        function updateHousingRoomsTable() {
            const tbody = document.getElementById('housing-rooms-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            appData.housingRooms.forEach((room, index) => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getHousingRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const assignedGroups = getHousingRoomAssignedGroupsDisplay(roomKey);
                
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>${room.building}</td>
                    <td>${room.roomId}</td>
                    <td>${room.gender.charAt(0).toUpperCase() + room.gender.slice(1)}</td>
                    <td>${room.capacity}</td>
                    <td class="capacity-display ${availableSpace < 0 ? 'capacity-negative' : availableSpace === 0 ? 'capacity-zero' : 'capacity-positive'}">${availableSpace}</td>
                    <td style="font-size: 12px;">${assignedGroups}</td>
                `;
            });
        }

        function updateSmallGroupRoomsTable() {
            const tbody = document.getElementById('small-group-rooms-table');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            appData.smallGroupRooms.forEach((room, index) => {
                const roomKey = `${room.building}-${room.roomId}`;
                const occupiedCount = getSmallGroupRoomOccupancy(roomKey);
                const availableSpace = room.capacity - occupiedCount;
                const assignedGroups = getSmallGroupRoomAssignedGroupsDisplay(roomKey);
                
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>${room.building}</td>
                    <td>${room.roomId}</td>
                    <td>${room.gender === 'mixed' ? 'Mixed/Co-ed' : room.gender.charAt(0).toUpperCase() + room.gender.slice(1)}</td>
                    <td>${room.capacity}</td>
                    <td class="capacity-display ${availableSpace < 0 ? 'capacity-negative' : availableSpace === 0 ? 'capacity-zero' : 'capacity-positive'}">${availableSpace}</td>
                    <td style="font-size: 12px;">${assignedGroups}</td>
                `;
            });
        }

        // ===== SEARCH FUNCTIONALITY =====
        function performSearch() {
            const searchInput = document.getElementById('parish-search');
            const resultsDiv = document.getElementById('search-results');
            
            if (!searchInput || !resultsDiv) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const matchingGroups = appData.youthGroups.filter(group => 
                group.parish.toLowerCase().includes(searchTerm) ||
                group.id.toLowerCase().includes(searchTerm) ||
                group.leader.toLowerCase().includes(searchTerm)
            );
            
            if (matchingGroups.length === 0) {
                resultsDiv.innerHTML = '<div class="notification warning">🔍 No groups found matching your search.</div>';
                return;
            }
            
            let html = `<h3 style="color: #061d28; margin-bottom: 15px;">🔍 Search Results (${matchingGroups.length} found)</h3><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px;">`;
            
            matchingGroups.forEach(group => {
                html += createGroupCard(group, true);
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // ===== DATA MANAGEMENT =====
        function saveData() {
            const data = { ...appData, timestamp: new Date().toISOString(), version: '3.0' };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `mount2k_housing_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('Data saved successfully! Check your downloads folder.');
        }

        function loadData() {
            document.getElementById('load-file').click();
        }

        function handleLoadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.youthGroups) {
                        if (confirm('This will replace all current data. Continue?')) {
                            // Load all data
                            appData.youthGroups = data.youthGroups || [];
                            appData.housingRooms = data.housingRooms || [];
                            appData.smallGroupRooms = data.smallGroupRooms || [];
                            appData.housingAssignments = data.housingAssignments || { male: {}, female: {} };
                            appData.smallGroupAssignments = data.smallGroupAssignments || {};
                            appData.mealColorAssignments = data.mealColorAssignments || {};
                            
                            // Update all displays
                            updateAllDisplays();
                            
                            // Clear search
                            const searchInput = document.getElementById('parish-search');
                            if (searchInput) searchInput.value = '';
                            const resultsDiv = document.getElementById('search-results');
                            if (resultsDiv) resultsDiv.innerHTML = '';
                            
                            alert(`Data loaded successfully!\n• ${appData.youthGroups.length} youth groups\n• ${Object.keys(appData.mealColorAssignments).length} meal color assignments\n• All assignments preserved`);
                        }
                    } else {
                        alert('Invalid file format. Please select a valid JSON file.');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportToCSV() {
            const headers = [
                'Group ID', 'Parish Name', 'Group Leader', 'Phone Number',
                'Male Teens', 'Female Teens', 'Male Chaperones', 'Female Chaperones', 'Total People',
                'Special Accommodations', 'Small Group Leader', 'Meal Color',
                'Male Housing Assignments', 'Female Housing Assignments', 
                'Small Group Assignments', 'Housing Assignment Status', 'Small Group Assignment Status'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            appData.youthGroups.forEach(group => {
                const totalPeople = group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones;
                
                // Get assignments
                const maleHousingRooms = appData.housingAssignments.male[group.id] || [];
                const femaleHousingRooms = appData.housingAssignments.female[group.id] || [];
                const groupSmallGroupRooms = appData.smallGroupAssignments[group.id] || [];
                
                const maleHousingRoomNames = maleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                const femaleHousingRoomNames = femaleHousingRooms.map(roomKey => {
                    const room = appData.housingRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                const groupSmallGroupRoomNames = groupSmallGroupRooms.map(roomKey => {
                    const room = appData.smallGroupRooms.find(r => `${r.building}-${r.roomId}` === roomKey);
                    return room ? `${room.building} - ${room.roomId}` : roomKey;
                });
                
                const isHousingAssigned = maleHousingRooms.length > 0 || femaleHousingRooms.length > 0;
                const isSmallGroupAssigned = groupSmallGroupRooms.length > 0;
                
                const mealColor = appData.mealColorAssignments[group.id] || '';
                const seminarian = group.seminarianSgl || '';
                
                const row = [
                    group.id,
                    `"${group.parish}"`,
                    `"${group.leader}"`,
                    group.phone,
                    group.maleTeens,
                    group.femaleTeens,
                    group.maleChaperones,
                    group.femaleChaperones,
                    totalPeople,
                    `"${group.specialAccommodations || ''}"`,
                    `"${seminarian}"`,
                    `"${mealColor}"`,
                    `"${maleHousingRoomNames.join('; ')}"`,
                    `"${femaleHousingRoomNames.join('; ')}"`,
                    `"${groupSmallGroupRoomNames.join('; ')}"`,
                    isHousingAssigned ? 'Assigned' : 'Unassigned',
                    isSmallGroupAssigned ? 'Assigned' : 'Unassigned'
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `mount2k_assignments_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Complete assignment data exported to CSV successfully!');
        }

        function exportCompleteHTML() {
            try {
                const originalHTML = document.documentElement.outerHTML;
                
                const dataReplacements = {
                    youthGroups: JSON.stringify(appData.youthGroups, null, 16),
                    housingRooms: JSON.stringify(appData.housingRooms, null, 16),
                    smallGroupRooms: JSON.stringify(appData.smallGroupRooms, null, 16),
                    housingAssignments: JSON.stringify(appData.housingAssignments, null, 16),
                    smallGroupAssignments: JSON.stringify(appData.smallGroupAssignments, null, 16),
                    mealColorAssignments: JSON.stringify(appData.mealColorAssignments, null, 16)
                };
                
                const newLoadSampleDataFunction = `function loadSampleData() {
            appData.youthGroups = ${dataReplacements.youthGroups};

            appData.housingRooms = ${dataReplacements.housingRooms};

            appData.smallGroupRooms = ${dataReplacements.smallGroupRooms};

            appData.housingAssignments = ${dataReplacements.housingAssignments};
            
            appData.smallGroupAssignments = ${dataReplacements.smallGroupAssignments};
            
            appData.mealColorAssignments = ${dataReplacements.mealColorAssignments};
        }`;

                const startPattern = 'function loadSampleData() {';
                const endPattern = 'appData.mealColorAssignments = {';
                
                const startIndex = originalHTML.indexOf(startPattern);
                const tempEndIndex = originalHTML.indexOf(endPattern, startIndex);
                const functionEnd = originalHTML.indexOf('};', tempEndIndex) + 2;
                const closingBrace = originalHTML.indexOf('}', functionEnd);
                
                let modifiedHTML = originalHTML.substring(0, startIndex) + 
                                  newLoadSampleDataFunction + 
                                  originalHTML.substring(closingBrace + 1);
                
                const currentDate = new Date().toLocaleDateString();
                modifiedHTML = modifiedHTML.replace(
                    '<title>Mount 2000 Assignment Dashboard</title>',
                    `<title>Mount 2000 Assignment Dashboard - Saved ${currentDate}</title>`
                );
                
                const blob = new Blob([modifiedHTML], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                const filename = `mount2000_assignment_dashboard_${new Date().toISOString().split('T')[0]}.html`;
                link.href = url;
                link.download = filename;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                const totalGroups = appData.youthGroups.length;
                const totalParticipants = appData.youthGroups.reduce((total, group) => 
                    total + group.maleTeens + group.femaleTeens + group.maleChaperones + group.femaleChaperones, 0);
                
                alert(`✅ SUCCESS! Complete HTML site exported!\n\n📁 File: ${filename}\n\n📊 Data included:\n• ${totalGroups} Youth Groups\n• ${totalParticipants} Total Participants\n• All meal colors and seminarian assignments preserved\n\n🌐 Ready to upload to any web host!`);
                
            } catch (error) {
                console.error('Export error:', error);
                alert(`❌ Export Error: ${error.message}`);
            }
        }

        // ===== SYSTEM INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing system...');
            initializeSystem();
        });
    </script>
</body>
</html>